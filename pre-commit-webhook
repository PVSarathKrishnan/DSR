#!/usr/bin/env python3
"""
Git Pre-Commit Hook - Logs commit information to Google Sheets via Webhook
No Google API credentials needed!
Works with both terminal and GUI commits (VS Code, etc.)
"""

import sys
import os
import json
from datetime import datetime
from typing import Optional
import urllib.request
import urllib.error

# Add the parent directory to Python path to import our modules
hook_dir = os.path.dirname(os.path.abspath(__file__))
parent_dir = os.path.dirname(os.path.dirname(hook_dir))
sys.path.insert(0, parent_dir)

try:
    import webhook_config as config
except ImportError as e:
    print(f"‚ùå Error importing webhook_config: {e}")
    print("Make sure webhook_config.py is in the parent directory")
    sys.exit(0)  # Allow commit to proceed


def is_interactive_terminal() -> bool:
    """Check if running in an interactive terminal (not GUI)"""
    return sys.stdin.isatty() and sys.stdout.isatty()


def print_colored(message: str, color: str = config.COLOR_RESET):
    """Print colored message to terminal"""
    print(f"{color}{message}{config.COLOR_RESET}")


def print_divider():
    """Print a visual divider"""
    print_colored(config.EMOJI_DIVIDER * 42, config.COLOR_CYAN)


def get_commit_message() -> Optional[str]:
    """
    Extract commit message from Git
    
    Returns:
        Commit message or None if not found
    """
    try:
        # Check .git/COMMIT_EDITMSG
        git_dir = os.path.join(os.getcwd(), '.git')
        commit_msg_file = os.path.join(git_dir, 'COMMIT_EDITMSG')
        
        if os.path.exists(commit_msg_file):
            with open(commit_msg_file, 'r') as f:
                # Get first non-comment line
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#'):
                        return line
        
        return None
    except Exception as e:
        return None


def get_user_input(prompt: str, default: str = "") -> str:
    """
    Get user input with a default value
    
    Args:
        prompt: Prompt message
        default: Default value
    
    Returns:
        User input or default value
    """
    try:
        if default:
            user_input = input(f"{prompt} [{config.COLOR_CYAN}{default}{config.COLOR_RESET}]: ").strip()
            return user_input if user_input else default
        else:
            return input(f"{prompt}: ").strip()
    except KeyboardInterrupt:
        print()
        print_colored(f"\n{config.EMOJI_ERROR} Commit aborted by user", config.COLOR_RED)
        sys.exit(1)


def validate_time(time_str: str) -> float:
    """
    Validate and parse time input
    
    Args:
        time_str: Time string from user
    
    Returns:
        Valid time value (defaults to 1.0 if invalid)
    """
    try:
        time_value = float(time_str)
        if time_value > 0:
            return time_value
        else:
            print_colored(f"{config.EMOJI_WARNING} Invalid time value, using default: {config.DEFAULT_TIME} hours", 
                        config.COLOR_YELLOW)
            return config.DEFAULT_TIME
    except ValueError:
        print_colored(f"{config.EMOJI_WARNING} Invalid time value, using default: {config.DEFAULT_TIME} hours", 
                    config.COLOR_YELLOW)
        return config.DEFAULT_TIME


def show_gui_dialog(commit_msg: str) -> tuple[Optional[str], Optional[str], Optional[float]]:
    """
    Show GUI dialog for commit details (works on macOS and Windows)
    
    Args:
        commit_msg: The commit message to use as default title
    
    Returns:
        Tuple of (title, description, hours) or (None, None, None) if cancelled
    """
    import platform
    import subprocess
    
    system = platform.system()
    
    if system == "Darwin":  # macOS
        return show_macos_dialog(commit_msg)
    elif system == "Windows":
        return show_windows_dialog(commit_msg)
    else:  # Linux or other
        return show_tkinter_dialog(commit_msg)


def show_tkinter_dialog(commit_msg: str) -> tuple[Optional[str], Optional[str], Optional[float]]:
    """
    Cross-platform GUI dialog using tkinter (Windows, Linux, macOS fallback)
    """
    try:
        import tkinter as tk
        from tkinter import ttk
        
        result = {"cancelled": True, "title": "", "description": "", "hours": config.DEFAULT_TIME}
        
        def on_submit():
            result["cancelled"] = False
            result["title"] = title_var.get()
            result["description"] = desc_text.get("1.0", "end-1c")
            result["hours"] = hours_var.get()
            root.destroy()
        
        def on_cancel():
            result["cancelled"] = True
            root.destroy()
        
        # Create main window
        root = tk.Tk()
        root.title("DSR Commit Logger")
        root.geometry("500x400")
        root.resizable(False, False)
        
        # Set window icon (optional)
        try:
            root.iconbitmap(default="")
        except:
            pass
        
        # Main frame with padding
        main_frame = ttk.Frame(root, padding="20")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # Title
        title_label = ttk.Label(main_frame, text="üìù Log Commit to Google Sheets", font=("Helvetica", 14, "bold"))
        title_label.grid(row=0, column=0, columnspan=2, pady=(0, 20))
        
        # Task Title
        ttk.Label(main_frame, text="Task Title:", font=("Helvetica", 10, "bold")).grid(row=1, column=0, sticky=tk.W, pady=(0, 5))
        title_var = tk.StringVar(value=commit_msg)
        title_entry = ttk.Entry(main_frame, textvariable=title_var, width=50)
        title_entry.grid(row=2, column=0, columnspan=2, pady=(0, 15))
        title_entry.focus()
        
        # Description
        ttk.Label(main_frame, text="Description (optional):", font=("Helvetica", 10, "bold")).grid(row=3, column=0, sticky=tk.W, pady=(0, 5))
        desc_text = tk.Text(main_frame, width=50, height=6, font=("Helvetica", 10))
        desc_text.grid(row=4, column=0, columnspan=2, pady=(0, 15))
        
        # Time
        ttk.Label(main_frame, text="Time Taken (hours):", font=("Helvetica", 10, "bold")).grid(row=5, column=0, sticky=tk.W, pady=(0, 5))
        hours_var = tk.DoubleVar(value=config.DEFAULT_TIME)
        hours_frame = ttk.Frame(main_frame)
        hours_frame.grid(row=6, column=0, columnspan=2, sticky=tk.W, pady=(0, 20))
        
        hours_spinbox = ttk.Spinbox(hours_frame, from_=0.1, to=24.0, increment=0.5, textvariable=hours_var, width=10)
        hours_spinbox.pack(side=tk.LEFT)
        ttk.Label(hours_frame, text="  (e.g., 0.5, 1, 2.5)").pack(side=tk.LEFT)
        
        # Buttons
        button_frame = ttk.Frame(main_frame)
        button_frame.grid(row=7, column=0, columnspan=2)
        
        cancel_btn = ttk.Button(button_frame, text="Cancel", command=on_cancel, width=12)
        cancel_btn.pack(side=tk.LEFT, padx=5)
        
        submit_btn = ttk.Button(button_frame, text="Submit & Commit", command=on_submit, width=15)
        submit_btn.pack(side=tk.LEFT, padx=5)
        
        # Bind Enter key to submit (when not in text area)
        def on_enter(event):
            if event.widget != desc_text:
                on_submit()
        
        root.bind('<Return>', on_enter)
        root.bind('<Escape>', lambda e: on_cancel())
        
        # Center window
        root.update_idletasks()
        x = (root.winfo_screenwidth() // 2) - (root.winfo_width() // 2)
        y = (root.winfo_screenheight() // 2) - (root.winfo_height() // 2)
        root.geometry(f'+{x}+{y}')
        
        # Run dialog
        root.mainloop()
        
        if result["cancelled"]:
            return None, None, None
        else:
            hours = validate_time(str(result["hours"]))
            return result["title"], result["description"], hours
            
    except Exception as e:
        print(f"[DSR Logger] GUI error: {e} - using defaults")
        return commit_msg, "", config.DEFAULT_TIME


def show_macos_dialog(commit_msg: str) -> tuple[Optional[str], Optional[str], Optional[float]]:
    """
    macOS native dialog using AppleScript - Single form style
    """
    import subprocess
    
    # Escape for AppleScript
    escaped_msg = commit_msg.replace('"', '\\"').replace('\\', '\\\\')
    
    # Single form with all fields
    applescript = f'''
    set defaultTitle to "{escaped_msg}"
    set defaultTime to "{config.DEFAULT_TIME}"
    
    set dialogText to "Task Title:" & return & defaultTitle & return & return & "Description (optional):" & return & return & "Time (hours): " & defaultTime
    
    set userDialog to display dialog "üìù Log Commit to Google Sheets" & return & return & "Task Title:" default answer defaultTitle buttons {{"Cancel", "Next"}} default button "Next" with title "DSR Commit Logger"
    if button returned of userDialog is "Cancel" then
        error number -128
    end if
    set taskTitle to text returned of userDialog
    
    set descDialog to display dialog "Description (optional):" default answer "" buttons {{"Back", "Next"}} default button "Next" with title "DSR Commit Logger"
    if button returned of descDialog is "Back" then
        error number -128
    end if
    set taskDesc to text returned of descDialog
    
    set timeDialog to display dialog "Time Taken (hours):" default answer defaultTime buttons {{"Back", "Submit & Commit"}} default button "Submit & Commit" with title "DSR Commit Logger"
    if button returned of timeDialog is "Back" then
        error number -128
    end if
    set taskTime to text returned of timeDialog
    
    return taskTitle & "|SEPARATOR|" & taskDesc & "|SEPARATOR|" & taskTime
    '''
    
    try:
        result = subprocess.run(
            ['osascript', '-e', applescript],
            capture_output=True,
            text=True,
            timeout=300
        )
        
        if result.returncode == 0:
            output = result.stdout.strip()
            parts = output.split('|SEPARATOR|')
            
            if len(parts) == 3:
                title = parts[0].strip()
                description = parts[1].strip()
                hours = validate_time(parts[2].strip())
                return title, description, hours
        
        return None, None, None
            
    except:
        # Fallback to tkinter
        return show_tkinter_dialog(commit_msg)


def show_windows_dialog(commit_msg: str) -> tuple[Optional[str], Optional[str], Optional[float]]:
    """
    Windows dialog - uses tkinter for cross-platform consistency
    """
    return show_tkinter_dialog(commit_msg)


def send_to_webhook(data: dict) -> tuple[bool, Optional[str]]:
    """
    Send commit data to Apps Script webhook
    
    Args:
        data: Dictionary with commit data
    
    Returns:
        Tuple of (success: bool, error_message: Optional[str])
    """
    if not config.WEBHOOK_URL:
        return False, "Webhook URL not configured. Please set WEBHOOK_URL in webhook_config.py"
    
    try:
        # Prepare the request
        json_data = json.dumps(data).encode('utf-8')
        req = urllib.request.Request(
            config.WEBHOOK_URL,
            data=json_data,
            headers={'Content-Type': 'application/json'},
            method='POST'
        )
        
        # Send the request
        with urllib.request.urlopen(req, timeout=config.REQUEST_TIMEOUT) as response:
            response_data = json.loads(response.read().decode('utf-8'))
            
            if response_data.get('success'):
                return True, None
            else:
                return False, response_data.get('error', 'Unknown error from webhook')
    
    except urllib.error.HTTPError as e:
        return False, f"HTTP Error {e.code}: {e.reason}"
    
    except urllib.error.URLError as e:
        return False, f"Network error: {e.reason}"
    
    except TimeoutError:
        return False, "Request timed out"
    
    except Exception as e:
        return False, f"Unexpected error: {str(e)}"


def main():
    """Main hook execution - works with both terminal and GUI commits"""
    
    # Check if running in interactive terminal or GUI
    interactive = is_interactive_terminal()
    
    # Get commit message
    commit_msg = get_commit_message()
    if not commit_msg:
        commit_msg = "Commit"
    
    if interactive:
        # Interactive mode: Show terminal prompts
        print()
        print_colored(f"{config.EMOJI_PENCIL} Logging commit to Google Sheets...", config.COLOR_BLUE)
        print_divider()
        print(f"Commit Message: \"{config.COLOR_CYAN}{commit_msg}{config.COLOR_RESET}\"")
        print()
        
        # Prompt for task details
        task_title = get_user_input("Task Title", default=commit_msg)
        task_description = get_user_input("Task Description", default="")
        time_input = get_user_input("Time Taken in hours", default=str(config.DEFAULT_TIME))
        time_taken = validate_time(time_input)
        
        print()
        print_colored("Submitting to Google Sheets...", config.COLOR_BLUE)
    else:
        # Non-interactive mode (GUI commit): Show GUI dialog
        print(f"[DSR Logger] Opening input dialog...")
        
        task_title, task_description, time_taken = show_gui_dialog(commit_msg)
        
        # Check if user cancelled
        if task_title is None:
            print("[DSR Logger] ‚ùå Cancelled by user")
            sys.exit(1)  # Abort the commit
        
        print(f"[DSR Logger] Logging: {task_title[:50]}...")
    
    # Get current date
    current_date = datetime.now().strftime(config.DATE_FORMAT)
    
    # Prepare data for webhook
    webhook_data = {
        "date": current_date,
        "title": task_title,
        "description": task_description,
        "hours": time_taken,
        "sha": "pending"
    }
    
    # Send to webhook
    success, error_msg = send_to_webhook(webhook_data)
    
    if interactive:
        if success:
            print_colored(f"{config.EMOJI_CHECK} Logged to Google Sheets successfully!", config.COLOR_GREEN)
            print()
        else:
            print_colored(f"{config.EMOJI_WARNING} Failed to log to Google Sheets", config.COLOR_YELLOW)
            print_colored(f"   Reason: {error_msg}", config.COLOR_YELLOW)
            print_colored("   Commit will proceed anyway.", config.COLOR_YELLOW)
            print()
    else:
        # GUI mode: Show compact status
        if success:
            print("[DSR Logger] ‚úì Logged successfully")
        else:
            print(f"[DSR Logger] ‚ö† Warning: {error_msg}")
    
    # Always exit with 0 to allow commit to proceed
    sys.exit(0)


if __name__ == "__main__":
    main()
