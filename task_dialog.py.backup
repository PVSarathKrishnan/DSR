#!/usr/bin/env python3
"""
DSR Task Manager - PyQt5 Dialog (Updated Design)
Matches the mockup design with task dropdown, CRUD buttons, and time dropdown
"""

import sys
import json
import urllib.request
import urllib.error
from typing import Optional, Tuple

try:
    from PyQt5.QtWidgets import (
        QApplication, QDialog, QVBoxLayout, QHBoxLayout, QLabel,
        QLineEdit, QComboBox, QPushButton, QRadioButton,
        QButtonGroup, QTextEdit, QMessageBox, QInputDialog
    )
    from PyQt5.QtCore import Qt
    from PyQt5.QtGui import QFont
    PYQT5_AVAILABLE = True
except ImportError:
    PYQT5_AVAILABLE = False


class TaskDialog(QDialog):
    """Modern task management dialog matching mockup"""
    
    def __init__(self, webhook_url: str, commit_msg: str, branch: str, default_time: float = 1.0):
        super().__init__()
        
        self.webhook_url = webhook_url
        self.commit_msg = commit_msg
        self.branch = branch
        self.default_time = default_time
        
        self.result = {
            'cancelled': True,
            'taskName': '',
            'commitMessage': '',
            'time': default_time,
            'branch': branch,
            'status': 'In Progress'
        }
        
        self.tasks = []
        self.init_ui()
        self.load_tasks()
    
    def init_ui(self):
        """Initialize UI matching the mockup design"""
        self.setWindowTitle('ðŸ“ DSR Commit Logger')
        self.setMinimumWidth(550)
        self.setMinimumHeight(580)
        
        # Styling
        self.setStyleSheet("""
            QDialog {
                background-color: #f5f5f5;
            }
            QLabel {
                color: #333333;
                font-size: 12px;
            }
            QLabel[heading="true"] {
                font-size: 14px;
                font-weight: bold;
                color: #000000;
            }
            QComboBox, QLineEdit, QTextEdit {
                padding: 8px;
                border: 1px solid #cccccc;
                border-radius: 4px;
                background-color: #ffffff;
                color: #333333;
                font-size: 13px;
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: none;
                border-left: 5px solid transparent;
                border-right: 5px solid transparent;
                border-top: 5px solid #666666;
                margin-right: 8px;
            }
            QPushButton {
                padding: 8px 16px;
                border-radius: 4px;
                font-size: 13px;
                font-weight: 500;
                min-height: 20px;
            }
            QPushButton#small_btn {
                padding: 6px 10px;
                font-size: 12px;
                background-color: #e0e0e0;
                border: 1px solid #cccccc;
                color: #333333;
            }
            QPushButton#small_btn:hover {
                background-color: #d0d0d0;
            }
            QPushButton#skip_btn, QPushButton#cancel_btn {
                background-color: #e0e0e0;
                border: 1px solid #cccccc;
                color: #333333;
            }
            QPushButton#skip_btn:hover, QPushButton#cancel_btn:hover {
                background-color: #d0d0d0;
            }
            QPushButton#submit_btn {
                background-color: #007bff;
                border: none;
                color: #ffffff;
            }
            QPushButton#submit_btn:hover {
                background-color: #0056b3;
            }
            QRadioButton {
                font-size: 13px;
                spacing: 6px;
                color: #333333;
            }
            QRadioButton::indicator {
                width: 16px;
                height: 16px;
                border-radius: 8px;
                border: 2px solid #999999;
                background-color: #ffffff;
            }
            QRadioButton::indicator:checked {
                border: 2px solid #007bff;
                background-color: #007bff;
            }
        """)
        
        # Main layout
        layout = QVBoxLayout()
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)
        
        # Title
        title = QLabel('ðŸ“ DSR Commit Logger')
        title.setProperty("heading", True)
        title.setStyleSheet('font-size: 16px; font-weight: bold; margin-bottom: 10px;')
        layout.addWidget(title)
        
        # ===== TASK SECTION =====
        task_label = QLabel('Task: *')
        task_label.setProperty("heading", True)
        layout.addWidget(task_label)
        
        # Task row with dropdown and CRUD buttons
        task_row = QHBoxLayout()
        task_row.setSpacing(8)
        
        self.task_combo = QComboBox()
        self.task_combo.setEditable(False)
        self.task_combo.setMinimumWidth(300)
        task_row.addWidget(self.task_combo, 1)
        
        # CRUD Buttons
        self.new_btn = QPushButton('+ New')
        self.new_btn.setObjectName('small_btn')
        self.new_btn.setFixedWidth(70)
        self.new_btn.clicked.connect(self.create_task)
        task_row.addWidget(self.new_btn)
        
        self.edit_btn = QPushButton('âœï¸ Edit')
        self.edit_btn.setObjectName('small_btn')
        self.edit_btn.setFixedWidth(70)
        self.edit_btn.clicked.connect(self.edit_task)
        task_row.addWidget(self.edit_btn)
        
        self.del_btn = QPushButton('ðŸ—‘ï¸ Del')
        self.del_btn.setObjectName('small_btn')
        self.del_btn.setFixedWidth(70)
        self.del_btn.clicked.connect(self.delete_task)
        task_row.addWidget(self.del_btn)
        
        layout.addLayout(task_row)
        
        # ===== COMMIT MESSAGE =====
        commit_label = QLabel('Commit Message: * (editable)')
        commit_label.setProperty("heading", True)
        layout.addWidget(commit_label)
        
        self.commit_text = QTextEdit()
        self.commit_text.setPlainText(self.commit_msg)
        self.commit_text.setMinimumHeight(120)
        self.commit_text.setMaximumHeight(120)
        layout.addWidget(self.commit_text)
        
        # ===== TIME & STATUS ROW =====
        time_status_row = QHBoxLayout()
        time_status_row.setSpacing(30)
        
        # Time Column
        time_col = QVBoxLayout()
        time_col.setSpacing(8)
        
        time_label = QLabel('Time (hours): *')
        time_label.setProperty("heading", True)
        time_col.addWidget(time_label)
        
        self.time_combo = QComboBox()
        self.time_combo.setEditable(True)
        self.time_combo.setMinimumWidth(120)
        # Add time options from 0.5 to 8 hours
        time_options = [str(x * 0.5) for x in range(1, 17)]  # 0.5 to 8.0
        self.time_combo.addItems(time_options)
        self.time_combo.setCurrentText(str(self.default_time))
        time_col.addWidget(self.time_combo)
        
        time_status_row.addLayout(time_col)
        
        # Status Column
        status_col = QVBoxLayout()
        status_col.setSpacing(8)
        
        status_label = QLabel('Status: *')
        status_label.setProperty("heading", True)
        status_col.addWidget(status_label)
        
        status_buttons = QHBoxLayout()
        status_buttons.setSpacing(15)
        
        self.status_group = QButtonGroup()
        
        self.in_progress_radio = QRadioButton('In Progress')
        self.in_progress_radio.setChecked(True)
        self.status_group.addButton(self.in_progress_radio)
        status_buttons.addWidget(self.in_progress_radio)
        
        self.completed_radio = QRadioButton('Completed')
        self.status_group.addButton(self.completed_radio)
        status_buttons.addWidget(self.completed_radio)
        
        self.blocked_radio = QRadioButton('Blocked')
        self.status_group.addButton(self.blocked_radio)
        status_buttons.addWidget(self.blocked_radio)
        
        status_buttons.addStretch()
        status_col.addLayout(status_buttons)
        
        time_status_row.addLayout(status_col, 1)
        
        layout.addLayout(time_status_row)
        
        # ===== BRANCH INFO =====
        branch_label = QLabel(f'Branch: {self.branch} (auto-detected)')
        branch_label.setStyleSheet('color: #888888; font-size: 11px;')
        layout.addWidget(branch_label)
        
        # ===== BUTTONS =====
        layout.addSpacing(10)
        
        buttons_row = QHBoxLayout()
        buttons_row.setSpacing(10)
        
        skip_btn = QPushButton('Skip Logging')
        skip_btn.setObjectName('skip_btn')
        skip_btn.setFixedWidth(110)
        skip_btn.clicked.connect(self.skip_logging)
        buttons_row.addWidget(skip_btn)
        
        cancel_btn = QPushButton('Cancel')
        cancel_btn.setObjectName('cancel_btn')
        cancel_btn.setFixedWidth(110)
        cancel_btn.clicked.connect(self.cancel_dialog)
        buttons_row.addWidget(cancel_btn)
        
        buttons_row.addStretch()
        
        submit_btn = QPushButton('Log to Sheets')
        submit_btn.setObjectName('submit_btn')
        submit_btn.setFixedWidth(130)
        submit_btn.clicked.connect(self.submit_dialog)
        buttons_row.addWidget(submit_btn)
        
        layout.addLayout(buttons_row)
        
        self.setLayout(layout)
    
    def load_tasks(self):
        """Fetch tasks from Google Sheets"""
        try:
            url = f"{self.webhook_url}?action=getTasks"
            with urllib.request.urlopen(url, timeout=10) as response:
                data = json.loads(response.read().decode('utf-8'))
                if data.get('success'):
                    self.tasks = [task['name'] for task in data.get('tasks', [])]
                    if self.tasks:
                        self.task_combo.addItems(self.tasks)
                        self.task_combo.setCurrentIndex(0)
                        self.edit_btn.setEnabled(True)
                        self.del_btn.setEnabled(True)
                    else:
                        self.task_combo.addItem('Create a task here')
                        self.edit_btn.setEnabled(False)
                        self.del_btn.setEnabled(False)
                else:
                    self.task_combo.addItem('Create a task here')
                    self.edit_btn.setEnabled(False)
                    self.del_btn.setEnabled(False)
        except Exception as e:
            print(f"Error loading tasks: {e}")
            self.task_combo.addItem('Create a task here')
            self.edit_btn.setEnabled(False)
            self.del_btn.setEnabled(False)
    
    def create_task(self):
        """Create new task"""
        task_name, ok = QInputDialog.getText(self, 'Create Task', 'Enter task name:')
        if ok and task_name.strip():
            task_name = task_name.strip()
            try:
                data = json.dumps({"action": "createTask", "taskName": task_name}).encode('utf-8')
                req = urllib.request.Request(
                    self.webhook_url,
                    data=data,
                    headers={'Content-Type': 'application/json'},
                    method='POST'
                )
                with urllib.request.urlopen(req, timeout=10) as response:
                    result = json.loads(response.read().decode('utf-8'))
                    if result.get('success'):
                        # Reload tasks
                        self.task_combo.clear()
                        self.load_tasks()
                        # Select new task
                        idx = self.task_combo.findText(task_name)
                        if idx >= 0:
                            self.task_combo.setCurrentIndex(idx)
                        QMessageBox.information(self, 'Success', result.get('message', 'Task created'))
                    else:
                        QMessageBox.warning(self, 'Error', result.get('error', 'Failed to create task'))
            except Exception as e:
                QMessageBox.warning(self, 'Error', str(e))
    
    def edit_task(self):
        """Edit selected task"""
        current_task = self.task_combo.currentText()
        if not current_task or current_task == 'Create a task here':
            QMessageBox.warning(self, 'No Task', 'Please select a task to edit')
            return
        
        new_name, ok = QInputDialog.getText(self, 'Edit Task', f'Rename "{current_task}" to:', text=current_task)
        if ok and new_name.strip() and new_name != current_task:
            new_name = new_name.strip()
            try:
                data = json.dumps({"action": "updateTask", "oldName": current_task, "newName": new_name}).encode('utf-8')
                req = urllib.request.Request(
                    self.webhook_url,
                    data=data,
                    headers={'Content-Type': 'application/json'},
                    method='POST'
                )
                with urllib.request.urlopen(req, timeout=10) as response:
                    result = json.loads(response.read().decode('utf-8'))
                    if result.get('success'):
                        # Reload tasks
                        self.task_combo.clear()
                        self.load_tasks()
                        # Select renamed task
                        idx = self.task_combo.findText(new_name)
                        if idx >= 0:
                            self.task_combo.setCurrentIndex(idx)
                        QMessageBox.information(self, 'Success', result.get('message', 'Task updated'))
                    else:
                        QMessageBox.warning(self, 'Error', result.get('error', 'Failed to update task'))
            except Exception as e:
                QMessageBox.warning(self, 'Error', str(e))
    
    def delete_task(self):
        """Delete selected task"""
        current_task = self.task_combo.currentText()
        if not current_task or current_task == 'Create a task here':
            QMessageBox.warning(self, 'No Task', 'Please select a task to delete')
            return
        
        reply = QMessageBox.question(self, 'Confirm Delete', 
                                     f'Are you sure you want to delete "{current_task}"?',
                                     QMessageBox.Yes | QMessageBox.No)
        if reply == QMessageBox.Yes:
            try:
                data = json.dumps({"action": "deleteTask", "taskName": current_task}).encode('utf-8')
                req = urllib.request.Request(
                    self.webhook_url,
                    data=data,
                    headers={'Content-Type': 'application/json'},
                    method='POST'
                )
                with urllib.request.urlopen(req, timeout=10) as response:
                    result = json.loads(response.read().decode('utf-8'))
                    if result.get('success'):
                        # Reload tasks
                        self.task_combo.clear()
                        self.load_tasks()
                        QMessageBox.information(self, 'Success', result.get('message', 'Task deleted'))
                    else:
                        QMessageBox.warning(self, 'Error', result.get('error', 'Failed to delete task'))
            except Exception as e:
                QMessageBox.warning(self, 'Error', str(e))
    
    def get_selected_status(self):
        """Get selected status"""
        if self.in_progress_radio.isChecked():
            return 'In Progress'
        elif self.completed_radio.isChecked():
            return 'Completed'
        elif self.blocked_radio.isChecked():
            return 'Blocked'
        return 'In Progress'
    
    def submit_dialog(self):
        """Submit dialog"""
        task = self.task_combo.currentText()
        if not task or task == 'Create a task here':
            QMessageBox.warning(self, 'No Task', 'Please select or create a task')
            return
        
        commit = self.commit_text.toPlainText().strip()
        if not commit:
            QMessageBox.warning(self, 'No Message', 'Please enter a commit message')
            return
        
        try:
            time_value = float(self.time_combo.currentText())
        except ValueError:
            QMessageBox.warning(self, 'Invalid Time', 'Please enter a valid time value')
            return
        
        self.result['cancelled'] = False
        self.result['taskName'] = task
        self.result['commitMessage'] = commit
        self.result['time'] = time_value
        self.result['status'] = self.get_selected_status()
        self.accept()
    
    def skip_logging(self):
        """Skip logging"""
        self.result['cancelled'] = False
        self.result['taskName'] = ''  # Empty means skip
        self.accept()
    
    def cancel_dialog(self):
        """Cancel dialog"""
        self.result['cancelled'] = True
        self.reject()


def show_pyqt5_task_dialog(webhook_url: str, commit_msg: str, branch: str, default_time: float = 1.0) -> Tuple[str, str, float, str, str]:
    """
    Show PyQt5 task dialog
    Returns: (taskName, commitMessage, time, branch, status)
    """
    if not PYQT5_AVAILABLE:
        print("PyQt5 not available")
        return None, None, -1.0, None, None
    
    app = QApplication.instance()
    if app is None:
        app = QApplication(sys.argv)
    
    dialog = TaskDialog(webhook_url, commit_msg, branch, default_time)
    result_code = dialog.exec_()
    
    if dialog.result['cancelled'] or result_code != QDialog.Accepted:
        return None, None, -1.0, None, None
    elif dialog.result['taskName'] == '':
        return None, None, None, None, None  # Skipped
    else:
        return (
            dialog.result['taskName'],
            dialog.result['commitMessage'],
            dialog.result['time'],
            dialog.result['branch'],
            dialog.result['status']
        )


# For testing
if __name__ == '__main__':
    webhook_url = "https://script.google.com/macros/s/YOUR_ID/exec"
    commit_msg = "Fixed authentication bug"
    branch = "feature/auth"
    
    task, commit, time, branch, status = show_pyqt5_task_dialog(webhook_url, commit_msg, branch, 1.0)
    print(f"Task: {task}")
    print(f"Commit: {commit}")
    print(f"Time: {time}")
    print(f"Branch: {branch}")
    print(f"Status: {status}")
